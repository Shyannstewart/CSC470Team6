import tkinter as tk
import sys
from tkinter import messagebox
from datetime import date, timedelta, datetime
from decimal import Decimal, ROUND_HALF_UP

#defining reservations - Juelz Moore

class Reservation:
  def __init__(self, res_id, r_type, name, days, arrival, email, address="", phone=""):
    self.res_id = res_id
    self.r_type = r_type ###reservation types SD, C, I, P
    self.name = name
    self.days = days
    self.arrival = arrival
    self.email = email
    self.address = address
    self.phone = phone
    self.total = Decimal("0.00")
    self.status = "Active"  #status of reservation - active, checked in, checked out, canceled

#OOAD System Logic

class OOAD:
  def __init__(self):
    self.reservations = {}
    self.next_id = 1

  def date_format(self, s):
    m, d, y = s.split("/")
    return date(int(y), int(m), int(d))

  def stay_valid(self, s):
    return s.isdigit() and 1 <= int(s) <= 14

  def email_valid(self, s):
    return "@" in s and "." in s and len(s) <= 40

  def res_type(self, r_type):
    return {
      "SD": "60-Day",
      "C": "Conventional",
      "I": "Incentive",
      "P": "Prepaid"
    }.get(r_type, "Unknown")

  def res_price(self, r_type, days):
    base = Decimal("100")

    if r_type == "SD":
      return base * days
    if r_type == "C":
      return base * days * Decimal("1.10")
    if r_type == "I":
      return base * days * Decimal("0.80")
    if r_type == "P":
      return base * days * Decimal("0.90")

  def list_reservations(self):
    return list(self.reservations.values())

  def add_res(self, r_type, form):
    name = form["name"].strip()
    days = form["days"]
    arrival = form["arrival"]
    email = form["email"].strip()
    address = form.get("address", "").strip()
    phone = form.get("phone", "").strip()

    if name == "" or len(name) > 35:
      raise ValueError("Invalid name")
    if not self.stay_valid(days):
      raise ValueError("Days must be 1-14")
    if not self.email_valid(email):
      raise ValueError("Invalid email")

    if address == "":
      raise ValueError("Address is required")
    if len(address) > 75:
      raise ValueError("Address must be 75 characters or less")
    addr_parts = [p.strip() for p in address.split(",")]
    if len(addr_parts) != 4 or any(not p for p in addr_parts):
      raise ValueError("Address must be in 'Street, City, State, ZIP' format")

    if phone == "":
      raise ValueError("Phone number is required")
    if len(phone) > 15:
      raise ValueError("Phone number must be 15 characters or less")

    arrival_date = self.date_format(arrival)
    days_int = int(days)

    res = Reservation(
      self.next_id,
      r_type,
      name,
      days_int,
      arrival_date,
      email,
      address,
      phone
    )

    res.total = self.res_price(r_type, days_int)
    self.reservations[self.next_id] = res
    self.next_id += 1
    return res

  def cancel_reservation(self, res_id):
    res_id = int(res_id)
    if res_id not in self.reservations:
      raise ValueError("Reservation not found")
    self.reservations[res_id].status = "CANCELED"
    return self.reservations[res_id]

  def check_in(self, res_id):
    res_id = int(res_id)
    if res_id not in self.reservations:
      raise ValueError("Reservation not found")

    res = self.reservations[res_id]
    if res.status == "CANCELED":
      raise ValueError("Cannot check in a canceled reservation")

    res.status = "CHECKED IN"
    return res

  def check_out(self, res_id):
    res_id = int(res_id)
    if res_id not in self.reservations:
      raise ValueError("Reservation not found")

    res = self.reservations[res_id]
    if res.status != "CHECKED IN":
      raise ValueError("Must be check in first")

    res.status = "CHECKED OUT"
    return res

  def update_reservation(self, res_id, updates):
    res_id = int(res_id)
    if res_id not in self.reservations:
      raise ValueError("Reservation not found")

    res = self.reservations[res_id]

    if "name" in updates:
      name = updates["name"].strip()
      if name == "" or len(name) > 35:
        raise ValueError("Invalid name")
      res.name = name

    if "days" in updates:
      days_str = updates["days"]
      if not self.stay_valid(days_str):
        raise ValueError("Days must be 1-14")
      res.days = int(days_str)

    if "arrival" in updates:
      arrival_str = updates["arrival"]
      res.arrival = self.date_format(arrival_str)

    if "email" in updates:
      email = updates["email"].strip()
      if not self.email_valid(email):
        raise ValueError("Invalid email")
      res.email = email

    if "address" in updates:
      address = updates["address"].strip()
      if address == "":
        raise ValueError("Address is required")
      if len(address) > 75:
        raise ValueError("Address must be 75 characters or less")
      addr_parts = [p.strip() for p in address.split(",")]
      if len(addr_parts) != 4 or any(not p for p in addr_parts):
        raise ValueError("Address must be in 'Street, City, State, ZIP' format")
      res.address = address

    if "phone" in updates:
      phone = updates["phone"].strip()
      if phone == "":
        raise ValueError("Phone number is required")
      if len(phone) > 15:
        raise ValueError("Phone number must be 15 characters or less")
      res.phone = phone

    if "r_type" in updates:
      r_type = updates["r_type"]
      if r_type not in ["SD", "C", "I", "P"]:
        raise ValueError("Invalid reservation type")
      res.r_type = r_type

    res.total = self.res_price(res.r_type, res.days)
    return res

#REPORTS - Jose Guzman
class Reports:
    #Inherit Info from OOAD
    def __init__(self, ooad):
        self.ooad = ooad
        self.capacity = 45

    #define expected occupancy report 
    def expected_occupancy_report(self):
        start = date.today()
        days = 30

        #set format and store percentage
        report_lines = []
        total_occupancy_percent = 0

        #loop for info within timeframe
        for i in range(days):
            current_day = start + timedelta(days=i)

            prepaid = 0
            sixty_day = 0 
            conventional = 0
            incentive = 0
        
            #Nested loop for information gathering
            for res in self.ooad.reservations.values():
                #If room is not booked continue to next day
                if res.status != "Active":
                    continue
                
                #Else gather info
                stay_start = res.arrival
                stay_end = res.arrival + timedelta(days=res.days)

                if stay_start <= current_day < stay_end:
                    #Find Reservation type and add
                    if res.r_type == "P":
                        prepaid += 1
                    elif res.r_type == "SD":
                        sixty_day += 1
                    elif res.r_type == "C":
                        conventional += 1
                    elif res.r_type == "I":
                        incentive += 1

            #Organize info and formula for occupancy percent        
            total = prepaid + sixty_day + conventional + incentive
            occupancy_rate = (total/self.capacity) * 100
            total_occupancy_percent += occupancy_rate

            #Format to report
            report_lines.append(
                f"{current_day} | P:{prepaid} SD:{sixty_day} C:{conventional} "
                f"I:{incentive} | Total:{total} | {occupancy_rate:.1f}%"
            )

        #Loop calc rate and join lines
        avg_rate = total_occupancy_percent / days
        report_lines.append(f"\nAverage Expected Occupancy: {avg_rate:.1f}%")

        return "\n".join(report_lines)
    
    #Define expected income report
    def expected_income_report(self):
        start = date.today()
        days = 30

        report_lines = []
        total_income = Decimal("0.00")

        for i in range(days):
            current_day = start + timedelta(days=i)
            day_income = Decimal("0.00")

            for res in self.ooad.reservations.values():
                if res.status != "Active":
                    continue

                stay_start = res.arrival
                stay_end = res.arrival + timedelta(days=res.days)

                #Check if reservation is active
                if stay_start <= current_day < stay_end:
                    nightly = self.ooad.res_price(res.r_type, 1)
                    day_income += nightly

            report_lines.append(f"{current_day} | ${day_income:.2f}")
            total_income += day_income
    
        avg_income = total_income / days
        report_lines.append(f"\nTotal Expected Income: ${total_income:.2f}")
        report_lines.append(f"Average Nightly Income: ${avg_income:.2f}")

        return "\n".join(report_lines)

    #Define incentive report 
    def incentive_discount_report(self):
        start = date.today()
        days = 30

        report_lines = []
        total_discount = Decimal("0.00")

        for i in range(days):
            current_day = start + timedelta(days=i)
            nightly_loss = Decimal("0.00")

            for res in self.ooad.reservations.values():
                if res.status != "Active":
                    continue

                stay_start = res.arrival
                stay_end = res.arrival + timedelta(days=res.days)

                if stay_start <= current_day < stay_end and res.r_type == "I":
                    full_rate = self.ooad.res_price("C", 1)
                    incentive_rate = self.ooad.res_price("I", 1)
                    nightly_loss += (full_rate - incentive_rate)

            report_lines.append(f"{current_day} | ${nightly_loss:.2f}")
            total_discount += nightly_loss

        avg_discount = total_discount / days
        report_lines.append(f"\nTotal Incentive Discount: ${total_discount:.2f}")
        report_lines.append(f"Average Incentive Discount: ${avg_discount:.2f}")

        return "\n".join(report_lines)

    #Daily Arrivals Report
    def daily_arrivals_report(self, target_day=None):
        if target_day is None:
            target_day = date.today()

        arrivals = []

        for res in self.ooad.reservations.values():
            if res.status != "Active":
                continue

            if res.arrival == target_day:
                departure = res.arrival + timedelta(days=res.days)
                room_number = 100 + res.res_id
                arrivals.append((res.name, res.r_type, room_number, departure))

        arrivals.sort(key=lambda x: x[0])  # sort by guest name

        report_lines = [f"Arrivals Report for {target_day}:\n"]

        if not arrivals:
            report_lines.append("No expected arrivals today.")
        else:
            for name, rtype, room, dep in arrivals:
                report_lines.append(
                    f"{name} | Type:{rtype} | Room {room} | Departs {dep}"
                )

        return "\n".join(report_lines)

    #Daily occupancy report 
    def daily_occupancy_report(self, target_day=None):
        if target_day is None:
            target_day = date.today()

        occupants = []

        for res in self.ooad.reservations.values():
            if res.status not in ("Active", "CHECKED IN"):
                continue

            stay_start = res.arrival
            stay_end = res.arrival + timedelta(days=res.days)

            if stay_start <= target_day < stay_end:
                room_number = 100 + res.res_id
                departure = stay_end
                name = res.name

                # mark departure
                if target_day == stay_end:
                    name = "*" + name

                occupants.append((room_number, name, departure))

        occupants.sort(key=lambda x: x[0])

        report_lines = [f"Occupancy Report for {target_day}:\n"]

        if not occupants:
            report_lines.append("No occupied rooms today.")
        else:
            for room, name, dep_date in occupants:
                report_lines.append(f"Room {room} | {name} | Departs {dep_date}")

        return "\n".join(report_lines)

    #Accomodation bill
    def print_bill(self, res_id):
        res = self.ooad.reservations.get(res_id)
        if not res:
            raise ValueError("Reservation not found")

        today = date.today()
        arrival = res.arrival
        departure = res.arrival + timedelta(days=res.days)
        nights = res.days
        room = getattr(res, "room", "UNASSIGNED")
        total = res.total

        lines = []
        lines.append(f"Accommodation Bill — Printed {today}")
        lines.append("--------------------------------------")
        lines.append(f"Guest Name: {res.name}")
        lines.append(f"Room Number: {room}")
        lines.append(f"Arrival Date: {arrival}")
        lines.append(f"Departure Date: {departure}")
        lines.append(f"Nights: {nights}")
        lines.append(f"Total Charge: ${total:.2f}")

        if res.r_type in ("P", "SD"):
            lines.append(f"\nPaid in Advance: {res.paid_date}")
            lines.append(f"Amount Paid: ${total:.2f}")

        return "\n".join(lines)
    
 #Jaheim Patterson Billing Demo 
   
def display_rooms():
    print("\nAvailable Rooms:")
    print("1. Single Room  - $80 per night")
    print("2. Double Room  - $120 per night")
    print("3. Deluxe Room  - $200 per night\n")

def get_room_price(choice: int) -> Decimal:
    prices = {
        1: Decimal("80.00"),
        2: Decimal("120.00"),
        3: Decimal("200.00")
    }
    return prices.get(choice, None)

def calculate_bill(room_price: Decimal, nights: int, discount: Decimal = Decimal("0.00")):
    subtotal = (room_price * Decimal(nights)).quantize(Decimal("0.01"), rounding=ROUND_HALF_UP)
    tax = (subtotal * Decimal("0.10")).quantize(Decimal("0.01"), rounding=ROUND_HALF_UP)  # 10% tax
    total = (subtotal + tax - discount).quantize(Decimal("0.01"), rounding=ROUND_HALF_UP)
    return subtotal, tax, total

def billing_cli():
    print("===================================")
    print("      HOTEL BILLING SYSTEM")
    print("===================================")

    name = input("Enter Guest Name: ").strip()
    try:
        nights = int(input("Enter number of nights: ").strip())
    except ValueError:
        print("Invalid number of nights")
        return

    display_rooms()
    try:
        room_choice = int(input("Choose a room (1-3): ").strip())
    except ValueError:
        print("Invalid choice")
        return

    price = get_room_price(room_choice)
    if price is None:
        print("Invalid room choice!")
        return

    discount_option = input("Apply discount? (yes/no): ").lower().strip()
    discount = Decimal("0.00")
    if discount_option == "yes":
        try:
            discount = Decimal(input("Enter discount amount (e.g. 10.00): ").strip())
        except Exception:
            print("Invalid discount amount; using 0.00")
            discount = Decimal("0.00")

    subtotal, tax, total = calculate_bill(price, nights, discount)

    print("\n===================================")
    print("              BILL")
    print("===================================")
    print(f"Guest Name      : {name}")
    print(f"Nights Stayed   : {nights}")
    print(f"Room Price      : ${price}")
    print(f"Subtotal        : ${subtotal:.2f}")
    print(f"Tax (10%)       : ${tax:.2f}")
    print(f"Discount        : -${discount:.2f}")
    print("-----------------------------------")
    print(f"Total Amount    : ${total:.2f}")
    print("===================================")

# -------------------------
# Example usage / small demo
# -------------------------
def demo_ooad_and_reports():
    o = OOAD()
    # add some sample reservations
    try:
        o.add_res("P", {"name": "Alice", "days": "3", "arrival": "11/28/2025", "email": "alice@example.com", "address": "123 Main St, Fayetteville, NC, 28301", "phone": "9105551234"})
        o.add_res("C", {"name": "Bob", "days": "2", "arrival": "11/27/2025", "email": "bob@example.com", "address": "456 Oak Rd, Raleigh, NC, 27601", "phone": "9195559876"})
        o.add_res("SD", {"name": "Charlie", "days": "5", "arrival": "12/01/2025", "email": "charlie@example.com", "address": "789 Pine Ave, Durham, NC, 27701", "phone": "9845554321"})
    except ValueError as e:
        print("Demo add_res error:", e)

    print("\nAll reservations:")
    for r in o.list_reservations():
        print(r)

    report = Reports(o)
    print("\nExpected occupancy (next 7 days):")
    print(report.expected_occupancy_report()[:7])

def run_gui():
    ooad = OOAD()

    root = tk.Tk()
    root.title("Ophelia's Oasis HRS")

    # ---------- Left side: Reservation form ----------
    form_frame = tk.Frame(root, padx=10, pady=10)
    form_frame.grid(row=0, column=0, sticky="n")

    tk.Label(form_frame, text="Name:").grid(row=0, column=0, sticky="w")
    name_entry = tk.Entry(form_frame, width=25)
    name_entry.grid(row=0, column=1)

    tk.Label(form_frame, text="Days (1–14):").grid(row=1, column=0, sticky="w")
    days_entry = tk.Entry(form_frame, width=10)
    days_entry.grid(row=1, column=1, sticky="w")

    tk.Label(form_frame, text="Arrival (MM/DD/YYYY):").grid(row=2, column=0, sticky="w")
    arrival_entry = tk.Entry(form_frame, width=15)
    arrival_entry.grid(row=2, column=1, sticky="w")

    tk.Label(form_frame, text="Email:").grid(row=3, column=0, sticky="w")
    email_entry = tk.Entry(form_frame, width=25)
    email_entry.grid(row=3, column=1)

    # Address and phone section
    tk.Label(form_frame, text="Address (Street, City, State, ZIP):").grid(row=4, column=0, sticky="w")
    address_entry = tk.Entry(form_frame, width=35)
    address_entry.grid(row=4, column=1)

    tk.Label(form_frame, text="Phone:").grid(row=5, column=0, sticky="w")
    phone_entry = tk.Entry(form_frame, width=20)
    phone_entry.grid(row=5, column=1)

    tk.Label(form_frame, text="Type:").grid(row=6, column=0, sticky="w")
    type_var = tk.StringVar(value="C")
    type_menu = tk.OptionMenu(form_frame, type_var, "SD", "C", "I", "P")
    type_menu.grid(row=6, column=1, sticky="w")

    def add_reservation():
        form = {
            "name": name_entry.get(),
            "days": days_entry.get(),
            "arrival": arrival_entry.get(),
            "email": email_entry.get(),
            "address": address_entry.get(),
            "phone": phone_entry.get()
        }
        r_type = type_var.get()
        try:
            res = ooad.add_res(r_type, form)
            messagebox.showinfo("Success", f"Reservation #{res.res_id} created.\nTotal: ${res.total}")
            refresh_listbox()
        except ValueError as e:
            messagebox.showerror("Error", str(e))

    add_button = tk.Button(form_frame, text="Add Reservation", command=add_reservation)
    add_button.grid(row=7, column=0, columnspan=2, pady=8)

    # Update reservation section
    tk.Label(form_frame, text="Update by Reservation ID (max 9 digits):").grid(row=8, column=0, sticky="w")
    update_id_entry = tk.Entry(form_frame, width=15)
    update_id_entry.grid(row=8, column=1, sticky="w")

    def update_reservation_gui():
        res_id_str = update_id_entry.get().strip()
        if not res_id_str.isdigit() or len(res_id_str) > 9:
            messagebox.showerror("Error", "Reservation ID must be up to 9 digits.")
            return

        updates = {}

        name = name_entry.get().strip()
        if name != "":
            updates["name"] = name

        days = days_entry.get().strip()
        if days != "":
            updates["days"] = days

        arrival = arrival_entry.get().strip()
        if arrival != "":
            updates["arrival"] = arrival

        email = email_entry.get().strip()
        if email != "":
            updates["email"] = email

        address = address_entry.get().strip()
        if address != "":
            updates["address"] = address

        phone = phone_entry.get().strip()
        if phone != "":
            updates["phone"] = phone

        r_type_new = type_var.get().strip()
        if r_type_new != "":
            updates["r_type"] = r_type_new

        if not updates:
            messagebox.showwarning("No Changes", "Enter at least one field to update.")
            return

        try:
            res = ooad.update_reservation(res_id_str, updates)
            messagebox.showinfo("Updated", f"Reservation #{res.res_id} updated successfully.")
            refresh_listbox()
        except ValueError as e:
            messagebox.showerror("Error", str(e))

    update_button = tk.Button(form_frame, text="Update Reservation", command=update_reservation_gui)
    update_button.grid(row=9, column=0, columnspan=2, pady=6)

    # ---------- Right side: Reservation list + actions ----------
    list_frame = tk.Frame(root, padx=10, pady=10)
    list_frame.grid(row=0, column=1, sticky="n")

    tk.Label(list_frame, text="Reservations:").grid(row=0, column=0, sticky="w")

    res_listbox = tk.Listbox(list_frame, width=70, height=12)
    res_listbox.grid(row=1, column=0, columnspan=3)

    def refresh_listbox():
        res_listbox.delete(0, tk.END)
        for res in ooad.list_reservations():
            line = (
                f"ID {res.res_id} | {res.name} | {res.r_type} | "
                f"{res.arrival} | {res.days} nights | {res.status}"
            )
            res_listbox.insert(tk.END, line)

    def get_selected_res_id():
        sel = res_listbox.curselection()
        if not sel:
            messagebox.showwarning("Select", "Please select a reservation first.")
            return None
        line = res_listbox.get(sel[0])
        try:
            parts = line.split()
            return int(parts[1])
        except Exception:
            messagebox.showerror("Error", "Could not parse reservation ID.")
            return None

    def do_check_in():
        res_id = get_selected_res_id()
        if res_id is None:
            return
        try:
            res = ooad.check_in(res_id)
            messagebox.showinfo("Checked In", f"Reservation #{res.res_id} is now CHECKED IN.")
            refresh_listbox()
        except ValueError as e:
            messagebox.showerror("Error", str(e))

    def do_check_out():
        res_id = get_selected_res_id()
        if res_id is None:
            return
        try:
            res = ooad.check_out(res_id)
            messagebox.showinfo("Checked Out", f"Reservation #{res.res_id} is now CHECKED OUT.")
            refresh_listbox()
        except ValueError as e:
            messagebox.showerror("Error", str(e))

    def do_cancel():
        res_id = get_selected_res_id()
        if res_id is None:
            return
        try:
            res = ooad.cancel_reservation(res_id)
            messagebox.showinfo("Canceled", f"Reservation #{res.res_id} is now CANCELED.")
            refresh_listbox()
        except ValueError as e:
            messagebox.showerror("Error", str(e))

    checkin_button = tk.Button(list_frame, text="Check In", command=do_check_in)
    checkin_button.grid(row=2, column=0, pady=5, sticky="w")

    checkout_button = tk.Button(list_frame, text="Check Out", command=do_check_out)
    checkout_button.grid(row=2, column=1, pady=5, sticky="w")

    cancel_button = tk.Button(list_frame, text="Cancel", command=do_cancel)
    cancel_button.grid(row=2, column=2, pady=5)

    def show_income_report():
      report = Reports(ooad)
      text = report.expected_income_report()

      win = tk.Toplevel(root)
      win.title("Expected Income (30 days)")

      txt = tk.Text(win, width=80, height=25)
      txt.pack(padx=10, pady=10)
      txt.insert("1.0", text)
      txt.config(state="disabled")

  income_button = tk.Button(list_frame, text="Show Income Report", command=show_income_report)
  income_button.grid(row=4, column=0, columnspan=3, pady=10)


    def show_incentive_report():
      report = Reports(ooad)
      text = report.incentive_discount_report()

      win = tk.Toplevel(root)
      win.title("Incentive Discount Report (30 days)")

      txt = tk.Text(win, width=80, height=25)
      txt.pack(padx=10, pady=10)
      txt.insert("1.0", text)
      txt.config(state="disabled")

  incentive_button = tk.Button(list_frame, text="Show Incentive Report", command=show_incentive_report)
  incentive_button.grid(row=5, column=0, columnspan=3, pady=10)


    def show_arrivals_report():
      report = Reports(ooad)
      text = report.daily_arrivals_report()

      win = tk.Toplevel(root)
      win.title("Daily Arrivals Report")

      txt = tk.Text(win, width=80, height=25)
      txt.pack(padx=10, pady=10)
      txt.insert("1.0", text)
      txt.config(state="disabled")

  arrivals_button = tk.Button(list_frame, text="Show Arrivals Report", command=show_arrivals_report)
  arrivals_button.grid(row=6, column=0, columnspan=3, pady=10)


    def show_daily_occupancy():
      report = Reports(ooad)
      text = report.daily_occupancy_report()

      win = tk.Toplevel(root)
      win.title("Daily Occupancy Report")

      txt = tk.Text(win, width=80, height=25)
      txt.pack(padx=10, pady=10)
      txt.insert("1.0", text)
      txt.config(state="disabled")

  daily_occ_button = tk.Button(list_frame, text="Show Daily Occupancy", command=show_daily_occupancy)
  daily_occ_button.grid(row=7, column=0, columnspan=3, pady=10)


    def show_bill_window():
      bill_win = tk.Toplevel(root)
      bill_win.title("Print Accommodation Bill")

      tk.Label(bill_win, text="Reservation ID:").grid(row=0, column=0, padx=10, pady=10)
      entry = tk.Entry(bill_win)
      entry.grid(row=0, column=1, padx=10, pady=10)

    def generate_bill():
        res_id = int(entry.get())
        report = Reports(ooad)
        text = report.print_bill(res_id)

        win = tk.Toplevel(root)
        win.title(f"Bill for Reservation {res_id}")

        txt = tk.Text(win, width=80, height=25)
        txt.pack(padx=10, pady=10)
        txt.insert("1.0", text)
        txt.config(state="disabled")

    gen_button = tk.Button(bill_win, text="Generate Bill", command=generate_bill)
    gen_button.grid(row=1, column=0, columnspan=2, pady=10)

    bill_button = tk.Button(list_frame, text="Print Accommodation Bill", command=show_bill_window)
    bill_button.grid(row=8, column=0, columnspan=3, pady=10)



    def check_availability():
        win = tk.Toplevel(root)
        win.title("Check Room Availability")
        win.geometry("400x300")
        
        tk.Label(win, text="Check Room Availability", font=("Arial", 12, "bold")).pack(pady=10)
        
        frame = tk.Frame(win, padx=20, pady=10)
        frame.pack()
        
        tk.Label(frame, text="Check-in Date (MM/DD/YYYY):").grid(row=0, column=0, sticky="w", pady=5)
        checkin_entry = tk.Entry(frame, width=15)
        checkin_entry.grid(row=0, column=1, pady=5)
        
        tk.Label(frame, text="Number of Nights (1-14):").grid(row=1, column=0, sticky="w", pady=5)
        nights_entry = tk.Entry(frame, width=10)
        nights_entry.grid(row=1, column=1, sticky="w", pady=5)
        
        result_text = tk.Text(win, width=45, height=8, state="disabled")
        result_text.pack(padx=20, pady=10)
        
        def do_check():
            checkin_str = checkin_entry.get().strip()
            nights_str = nights_entry.get().strip()
            
            result_text.config(state="normal")
            result_text.delete("1.0", tk.END)
            
            try:
                m, d, y = checkin_str.split("/")
                check_in_date = date(int(y), int(m), int(d))
            except:
                result_text.insert("1.0", "Error: Invalid date format. Use MM/DD/YYYY")
                result_text.config(state="disabled")
                return
            
            if not nights_str.isdigit() or not (1 <= int(nights_str) <= 14):
                result_text.insert("1.0", "Error: Nights must be between 1 and 14")
                result_text.config(state="disabled")
                return
            
            nights = int(nights_str)
            capacity = 45
            
            report_lines = []
            report_lines.append(f"Availability for {nights} night(s) starting {check_in_date}:\n")
            report_lines.append("-" * 40 + "\n")
            
            for i in range(nights):
                current_day = check_in_date + timedelta(days=i)
                occupied = 0
                
                for res in ooad.reservations.values():
                    if res.status not in ["Active", "CHECKED IN"]:
                        continue
                    stay_start = res.arrival
                    stay_end = res.arrival + timedelta(days=res.days)
                    if stay_start <= current_day < stay_end:
                        occupied += 1
                
                available = capacity - occupied
                report_lines.append(f"{current_day}: {available} rooms available\n")
            
            report_lines.append("-" * 40 + "\n")
            min_available = min([capacity - sum(1 for res in ooad.reservations.values() 
                if res.status in ["Active", "CHECKED IN"] and 
                res.arrival <= check_in_date + timedelta(days=i) < res.arrival + timedelta(days=res.days))
                for i in range(nights)])
            
            if min_available > 0:
                report_lines.append(f"You can book up to {min_available} room(s) for this period.")
            else:
                report_lines.append("No rooms available for the entire period.")
            
            result_text.insert("1.0", "".join(report_lines))
            result_text.config(state="disabled")
        
        check_button = tk.Button(win, text="Check Availability", command=do_check)
        check_button.pack(pady=5)

    availability_button = tk.Button(list_frame, text="Check Availability", command=check_availability)
    availability_button.grid(row=4, column=0, columnspan=3, pady=5)

    refresh_listbox()
    root.mainloop()
    


def log_action(action_type, room_number=None, guest_name=None, extra_info=None, log_file="hotel_log.txt"):
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    log_entry = f"{timestamp} | {action_type}"
    if room_number is not None:
        log_entry += f" | Room: {room_number}"
    if guest_name is not None:
        log_entry += f" | Guest: {guest_name}"
    if extra_info is not None:
        log_entry += f" | Notes: {extra_info}"

    with open(log_file, "a") as file:
        file.write(log_entry + "\n")

    print(f"[Logged: {action_type}]")


def is_room_available_for_dates(room_number, check_in_date, check_out_date, rooms_data):
    if room_number not in rooms_data["rooms"]:
        return False

    room = rooms_data["rooms"][room_number]

    for reservation in room["reservations"]:
        res_check_in = datetime.strptime(reservation["check_in_date"], "%Y-%m-%d")
        res_check_out = datetime.strptime(reservation["check_out_date"], "%Y-%m-%d")

        if check_in_date < res_check_out and res_check_in < check_out_date:
            return False

    return True


def verify_room_availability(rooms_data):
    print("\n--- Verify Room Availability (Console) ---")
    print("Available rooms:", list(rooms_data["rooms"].keys()))

    try:
        room_number = int(input("Enter room number: "))
    except ValueError:
        print("Error: Please enter a valid room number.")
        log_action("ERROR", extra_info="Invalid room number entered for availability check")
        return

    if room_number not in rooms_data["rooms"]:
        print(f"Error: Room {room_number} does not exist.")
        log_action("ERROR", room_number=room_number, extra_info="Room not found")
        return

    print("Enter dates in format YYYY-MM-DD (e.g., 2024-01-15)")
    check_in_str = input("Check-in date: ")
    check_out_str = input("Check-out date: ")

    try:
        check_in_date = datetime.strptime(check_in_str, "%Y-%m-%d")
        check_out_date = datetime.strptime(check_out_str, "%Y-%m-%d")
    except ValueError:
        print("Error: Invalid date format.")
        log_action("ERROR", room_number=room_number, extra_info="Invalid date format")
        return

    if check_in_date >= check_out_date:
        print("Error: Check-out must be after check-in.")
        log_action("ERROR", room_number=room_number, extra_info="Check-out before check-in")
        return

    if is_room_available_for_dates(room_number, check_in_date, check_out_date, rooms_data):
        room = rooms_data["rooms"][room_number]
        nights = (check_out_date - check_in_date).days
        print(f"Room {room_number} is AVAILABLE")
        print(f"Total cost for {nights} nights: ${room['price_per_night'] * nights}")
        log_action("AVAILABILITY_CHECK", room_number=room_number,
                   extra_info=f"Available for {check_in_str} to {check_out_str}")
    else:
        print(f"Room {room_number} is NOT AVAILABLE for those dates.")
        log_action("AVAILABILITY_CHECK", room_number=room_number,
                   extra_info=f"Not available for {check_in_str} to {check_out_str}")


def check_in_guest(rooms_data):
    print("\n--- Check In Guest (Console) ---")

    guest_name = input("Enter guest name: ").strip()
    if not guest_name:
        print("Error: Guest name cannot be empty.")
        log_action("ERROR", extra_info="Empty guest name for check-in")
        return

    try:
        room_number = int(input("Enter room number: "))
    except ValueError:
        print("Error: Please enter a valid room number.")
        log_action("ERROR", guest_name=guest_name, extra_info="Invalid room number for check-in")
        return

    if room_number not in rooms_data["rooms"]:
        print(f"Error: Room {room_number} does not exist.")
        log_action("ERROR", room_number=room_number, guest_name=guest_name,
                   extra_info="Room not found for check-in")
        return

    room = rooms_data["rooms"][room_number]

    if room["status"] == "occupied":
        print(f"Error: Room {room_number} is already occupied by {room['current_guest']}.")
        log_action("CHECK_IN_FAILED", room_number=room_number, guest_name=guest_name,
                   extra_info="Room already occupied")
        return

    reservation_found = None
    for reservation in room["reservations"]:
        if reservation["guest_name"].lower() == guest_name.lower() and not reservation["checked_in"]:
            reservation_found = reservation
            break

    if reservation_found is None:
        print(f"No reservation found for {guest_name} in room {room_number}.")
        log_action("CHECK_IN_FAILED", room_number=room_number, guest_name=guest_name,
                   extra_info="No matching reservation")
        return

    reservation_found["checked_in"] = True
    room["status"] = "occupied"
    room["current_guest"] = guest_name

    print(f"Check-in successful! Guest: {guest_name}, Room: {room_number}")
    log_action("CHECK_IN", room_number=room_number, guest_name=guest_name,
               extra_info=f"Check-out: {reservation_found['check_out_date']}")


def check_out_guest(rooms_data):
    print("\n--- Check Out Guest (Console) ---")

    try:
        room_number = int(input("Enter room number: "))
    except ValueError:
        print("Error: Invalid room number.")
        log_action("ERROR", extra_info="Invalid room number for check-out")
        return

    if room_number not in rooms_data["rooms"]:
        print(f"Room {room_number} does not exist.")
        log_action("ERROR", room_number=room_number, extra_info="Room not found for check-out")
        return

    room = rooms_data["rooms"][room_number]

    if room["status"] != "occupied":
        print(f"Room {room_number} is not currently occupied.")
        log_action("CHECK_OUT_FAILED", room_number=room_number, extra_info="Room not occupied")
        return

    guest_name = room["current_guest"]

    for i, reservation in enumerate(room["reservations"]):
        if reservation["guest_name"].lower() == guest_name.lower() and reservation["checked_in"]:
            check_in = datetime.strptime(reservation["check_in_date"], "%Y-%m-%d")
            check_out = datetime.strptime(reservation["check_out_date"], "%Y-%m-%d")
            nights = (check_out - check_in).days
            total_bill = nights * room["price_per_night"]
            room["reservations"].pop(i)
            break
    else:
        nights = 1
        total_bill = room["price_per_night"]

    room["status"] = "available"
    room["current_guest"] = None

    print(f"Check-out successful! Guest: {guest_name}, Total: ${total_bill}")
    log_action("CHECK_OUT", room_number=room_number, guest_name=guest_name,
               extra_info=f"Bill: ${total_bill}")


if __name__ == "__main__":
   
    if len(sys.argv) > 1:
        if sys.argv[1] == "demo":
            demo_ooad_and_reports()
        elif sys.argv[1] == "bill":
            billing_cli()
        elif sys.argv[1] == "gui":
            run_gui()
        else:
            print("Unknown option. Use one of: gui, demo, bill")
    else:
        
        run_gui()
