import tkinter as tk
import sys
from tkinter import messagebox
from datetime import date, timedelta
from decimal import Decimal, ROUND_HALF_UP

#defining reservations - Juelz Moore

class Reservation:
  def __init__(self, res_id, r_type, name, days, arrival, email):
    self.res_id = res_id
    self.r_type = r_type ###reservation types SD, C, I, P
    self.name = name
    self.days = days
    self.arrival = arrival
    self.email = email
    self.total = Decimal("0.00")
    self.status = "Active"  #status of reservation - active, checked in, checked out, canceled

#OOAD System Logic

class OOAD:
  def __init__(self):
    self.reservations = {}
    self.next_id = 1

  def date_format(self, s):
    m, d, y = s.split("/")
    return date(int(y), int(m), int(d))

  def stay_valid(self, s):
    return s.isdigit() and 1 <= int(s) <= 14

  def email_valid(self, s):
    return "@" in s and "." in s and len(s) <= 40

  def res_type(self, r_type):
    return {
      "SD": "60-Day",
      "C": "Conventional",
      "I": "Incentive",
      "P": "Prepaid"
    }.get(r_type, "Unknown")

  def res_price(self, r_type, days):
    base = Decimal("100")

    if r_type == "SD":
      return base * days
    if r_type == "C":
      return base * days * Decimal("1.10")
    if r_type == "I":
      return base * days * Decimal("0.80")
    if r_type == "P":
      return base * days * Decimal("0.90")

  def list_reservations(self):
    return list(self.reservations.values())

  def add_res(self, r_type, form):
    name = form["name"].strip()
    days = form["days"]
    arrival = form["arrival"]
    email = form["email"]

    if name == "" or len(name) > 35:
      raise ValueError("Invalid name")
    if not self.stay_valid(days):
      raise ValueError("Days must be 1-14")
    if not self.email_valid(email):
      raise ValueError("Invalid email")


    arrival_date = self.date_format(arrival)
    days_int = int(days)

    res = Reservation(
      self.next_id,
      r_type,
      name,
      days_int,
      arrival_date,
      email
    )

    res.total = self.res_price(r_type, days_int)
    self.reservations[self.next_id] = res
    self.next_id += 1
    return res

  def cancel_reservation(self, res_id):
    res_id = int(res_id)
    if res_id not in self.reservations:
      raise ValueError("Reservation not found")
    self.reservations[res_id].status = "CANCELED"
    return self.reservations[res_id]

  def check_in(self, res_id):
    res_id = int(res_id)
    if res_id not in self.reservations:
      raise ValueError("Reservation not found")

    res = self.reservations[res_id]
    if res.status == "CANCELED":
      raise ValueError("Cannot check in a canceled reservation")

    res.status = "CHECKED IN"
    return res

  def check_out(self, res_id):
    res_id = int(res_id)
    if res_id not in self.reservations:
      raise ValueError("Reservation not found")

    res = self.reservations[res_id]
    if res.status != "CHECKED IN":
      raise ValueError("Must be check in first")

    res.status = "CHECKED OUT"
    return res
#REPORTS - Jose Guzman
class Reports:
    #Inherit Info from OOAD
    def __init__(self, ooad):
        self.ooad = ooad
        self.capacity = 45

    #define expected occupancy report 
    def expected_occupancy_report(self):
        start = date.today()
        days = 30

        #set format and store percentage
        report_lines = []
        total_occupancy_percent = 0

        #loop for info within timeframe
        for i in range(days):
            current_day = start + timedelta(days=i)

            prepaid = 0
            sixty_day = 0 
            conventional = 0
            incentive = 0
        
            #Nested loop for information gathering
            for res in self.ooad.reservations.values():
                #If room is not booked continue to next day
                if res.status != "Active":
                    continue
                
                #Else gather info
                stay_start = res.arrival
                stay_end = res.arrival + timedelta(days=res.days)

                if stay_start <= current_day < stay_end:
                    #Find Reservation type and add
                    if res.r_type == "P":
                        prepaid += 1
                    elif res.r_type == "SD":
                        sixty_day += 1
                    elif res.r_type == "C":
                        conventional += 1
                    elif res.r_type == "I":
                        incentive += 1

            #Organize info and formula for occupancy percent        
            total = prepaid + sixty_day + conventional + incentive
            occupancy_rate = (total/self.capacity) * 100
            total_occupancy_percent += occupancy_rate

            #Format to report
            report_lines.append(
                f"{current_day} | P:{prepaid} SD:{sixty_day} C:{conventional} "
                f"I:{incentive} | Total:{total} | {occupancy_rate:.1f}%"
            )
        #Loop calc rate and join lines
        avg_rate = total_occupancy_percent / days
        report_lines.append(f"\nAverage Expected Occupancy: {avg_rate:.1f}%")

        return "\n".join(report_lines)
    
 #Jaheim Patterson Billing Demo 
   
def display_rooms():
    print("\nAvailable Rooms:")
    print("1. Single Room  - $80 per night")
    print("2. Double Room  - $120 per night")
    print("3. Deluxe Room  - $200 per night\n")

def get_room_price(choice: int) -> Decimal:
    prices = {
        1: Decimal("80.00"),
        2: Decimal("120.00"),
        3: Decimal("200.00")
    }
    return prices.get(choice, None)

def calculate_bill(room_price: Decimal, nights: int, discount: Decimal = Decimal("0.00")):
    subtotal = (room_price * Decimal(nights)).quantize(Decimal("0.01"), rounding=ROUND_HALF_UP)
    tax = (subtotal * Decimal("0.10")).quantize(Decimal("0.01"), rounding=ROUND_HALF_UP)  # 10% tax
    total = (subtotal + tax - discount).quantize(Decimal("0.01"), rounding=ROUND_HALF_UP)
    return subtotal, tax, total

def billing_cli():
    print("===================================")
    print("      HOTEL BILLING SYSTEM")
    print("===================================")

    name = input("Enter Guest Name: ").strip()
    try:
        nights = int(input("Enter number of nights: ").strip())
    except ValueError:
        print("Invalid number of nights")
        return

    display_rooms()
    try:
        room_choice = int(input("Choose a room (1-3): ").strip())
    except ValueError:
        print("Invalid choice")
        return

    price = get_room_price(room_choice)
    if price is None:
        print("Invalid room choice!")
        return

    discount_option = input("Apply discount? (yes/no): ").lower().strip()
    discount = Decimal("0.00")
    if discount_option == "yes":
        try:
            discount = Decimal(input("Enter discount amount (e.g. 10.00): ").strip())
        except Exception:
            print("Invalid discount amount; using 0.00")
            discount = Decimal("0.00")

    subtotal, tax, total = calculate_bill(price, nights, discount)

    print("\n===================================")
    print("              BILL")
    print("===================================")
    print(f"Guest Name      : {name}")
    print(f"Nights Stayed   : {nights}")
    print(f"Room Price      : ${price}")
    print(f"Subtotal        : ${subtotal:.2f}")
    print(f"Tax (10%)       : ${tax:.2f}")
    print(f"Discount        : -${discount:.2f}")
    print("-----------------------------------")
    print(f"Total Amount    : ${total:.2f}")
    print("===================================")

# -------------------------
# Example usage / small demo
# -------------------------
def demo_ooad_and_reports():
    o = OOAD()
    # add some sample reservations
    try:
        o.add_res("P", {"name": "Alice", "days": "3", "arrival": "11/28/2025", "email": "alice@example.com"})
        o.add_res("C", {"name": "Bob", "days": "2", "arrival": "11/27/2025", "email": "bob@example.com"})
        o.add_res("SD", {"name": "Charlie", "days": "5", "arrival": "12/01/2025", "email": "charlie@example.com"})
    except ValueError as e:
        print("Demo add_res error:", e)

    print("\nAll reservations:")
    for r in o.list_reservations():
        print(r)

    report = Reports(o)
    print("\nExpected occupancy (next 7 days):")
    print(report.expected_occupancy_report()[:7])

if __name__ == "__main__":
    # If run with argument "demo", run demo; with "bill", run billing CLI; otherwise show both choices
    if len(sys.argv) > 1 and sys.argv[1] == "demo":
        demo_ooad_and_reports()
    elif len(sys.argv) > 1 and sys.argv[1] == "bill":
        billing_cli()
    else:
        print("Run the script with one of the options:")
        print("  python hotel.py demo   # shows OOAD demo + report")
        print("  python hotel.py bill   # runs the billing CLI demo")
        # For convenience run demo by default
        demo_ooad_and_reports()
